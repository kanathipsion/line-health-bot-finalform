<script>
  document.getElementById('healthForm').addEventListener('submit', (event) => {
    event.preventDefault();

    const sugar = document.getElementById('sugar').value;
    const pressure = document.getElementById('pressure').value;
    const height = document.getElementById('height').value;
    const weight = document.getElementById('weight').value;
    const userId = document.getElementById('userId').value;

    const bmi = (weight / Math.pow(height / 100, 2)).toFixed(2);
    let healthResult = '';

    if (bmi < 18.5) {
      healthResult = 'น้ำหนักน้อย';
    } else if (bmi < 25) {
      healthResult = 'ปกติ';
    } else if (bmi < 30) {
      healthResult = 'น้ำหนักเกิน';
    } else {
      healthResult = 'อ้วน';
    }

    const healthMessage = `ผลลัพธ์สุขภาพของคุณ:\n- ค่าน้ำตาล: ${sugar}\n- ค่าความดัน: ${pressure}\n- BMI: ${bmi} (${healthResult})`;

    const packageId = '1';
    let stickerId = '13';
    if (healthResult === 'ปกติ') stickerId = '110';
    else if (healthResult === 'น้ำหนักเกิน') stickerId = '111';
    else if (healthResult === 'อ้วน') stickerId = '112';

    // ส่งข้อมูลไปยัง Google Apps Script
    fetch('https://script.google.com/macros/s/AKfycbxGAc9Q3TKBacVWEukWBJsVQsTtgAkAWZ6EHTr-FLuJOuGhucgL9ytKgUazOTQr7-A_cQ/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: userId,
        sugar: sugar,
        pressure: pressure,
        height: height,
        weight: weight,
        bmi: bmi,
        healthResult: healthResult,
        timestamp: new Date().toISOString(),
      }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('บันทึกข้อมูลใน Google Sheet ไม่สำเร็จ');
        }
        // ส่งข้อความไปยัง LINE
        return fetch('/send-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: userId,
            message: healthMessage,
            packageId: packageId,
            stickerId: stickerId,
          }),
        });
      })
      .then((response) => {
        if (!response.ok) {
          throw new Error('ส่งข้อความไปยัง LINE ไม่สำเร็จ');
        }
        alert('ส่งข้อมูลสำเร็จ! กรุณาตรวจสอบ LINE ของคุณ');
      })
      .catch((error) => {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาด: ' + error.message);
      });
  });
</script>
