<script>
  document.getElementById('healthForm').addEventListener('submit', (event) => {
    event.preventDefault();

    const sugar = document.getElementById('sugar').value;
    const pressure = document.getElementById('pressure').value;
    const height = document.getElementById('height').value;
    const weight = document.getElementById('weight').value;
    const userId = document.getElementById('userId').value;

    const bmi = (weight / Math.pow(height / 100, 2)).toFixed(2);

    const healthMessage = `ผลลัพธ์สุขภาพของคุณ:\n- ค่าน้ำตาล: ${sugar}\n- ค่าความดัน: ${pressure}\n- BMI: ${bmi}`;

    const packageId = '1';
    let stickerId = '13'; // ตัวอย่างสติกเกอร์

    if (bmi < 18.5) {
      stickerId = '110'; // น้ำหนักน้อย
    } else if (bmi < 25) {
      stickerId = '111'; // น้ำหนักปกติ
    } else if (bmi < 30) {
      stickerId = '112'; // น้ำหนักเกิน
    } else {
      stickerId = '113'; // อ้วน
    }

    // เรียก API สำหรับส่งข้อความและสติกเกอร์ไปยัง LINE
    fetch('/send-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: userId,
        message: healthMessage,
        packageId: packageId,
        stickerId: stickerId,
      }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('Failed to send message');
        }
        alert('ส่งข้อมูลสำเร็จ! กรุณาตรวจสอบ LINE ของคุณ');

        // หากส่งข้อความสำเร็จแล้ว บันทึกข้อมูลลง Google Sheets
        return fetch('https://script.google.com/macros/s/AKfycbyL3vKHt5oLMCe2sBcY77OGH0vzyYWQv-A6KBJ-fDvhcceixZ3LEJVHtsa0cpgj0aA0Ag/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: userId,
            sugar: sugar,
            pressure: pressure,
            height: height,
            weight: weight,
            bmi: bmi,
          }),
        });
      })
      .then((sheetResponse) => sheetResponse.json())
      .then((data) => {
        if (data.success) {
          console.log('Data saved to Google Sheets successfully!');
        } else {
          console.error('Error saving data to Google Sheets:', data.message);
        }
      })
      .catch((error) => {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาด: ' + error.message);
      });
  });
</script>
